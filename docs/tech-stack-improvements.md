# 技術スタック改善提案（Quizinart）

## 現状サマリ
- バックエンドは **Rust + Warp + Maud**、フロントは **HTMX + PicoCSS**、DB は **libSQL**（ローカル/リモート両対応）。
- DB スキーマはアプリ起動時に `CREATE TABLE IF NOT EXISTS` を実行する初期化方式。
- CI は主に Nix ビルド中心で、Rust の lint/test を明示的にゲートしていない。

---

## 優先度 High（まず着手）

### 1) DB マイグレーション基盤を導入（`refinery` or `sqlx migrate`）
**狙い**
- 現在の「起動時スキーマ作成」から、**バージョン管理されたマイグレーション**へ移行。
- 将来のカラム追加/変更を安全に実施し、ロールバック戦略を持てるようにする。

**効果**
- 本番・検証・ローカル間の差異を最小化。
- 破壊的変更時の運用リスクを減らす。

**実装の第一歩**
- `migrations/` ディレクトリを作成し、現行 DDL を `V1__init.sql` に切り出し。
- 起動処理で「適用済みバージョン確認→未適用 migration 実行」に置き換える。

---

### 2) CI の品質ゲート強化（`fmt`/`clippy`/`test`）
**狙い**
- 現在の Nix ビルド成功に加えて、**Rust 品質チェックを CI の必須ゲート**にする。

**効果**
- リグレッション・スタイル崩れ・潜在的な警告を PR 段階で早期検出。

**実装の第一歩**
- CI に以下ステップを追加。
  - `cargo fmt --all -- --check`
  - `cargo clippy --all-targets --all-features -- -D warnings`
  - `cargo test --all-targets --all-features`
- 将来的に `cargo nextest` へ移行すると高速化しやすい。

---

### 3) 管理者パスワードのハッシュ化（`argon2`）
**狙い**
- 管理者パスワードの保存を平文からハッシュ方式へ。

**効果**
- DB 漏えい時の被害を大幅に軽減。

**実装の第一歩**
- `argon2` 導入、`password_hash` クレートで verify。
- 既存データ移行のため、初回ログイン時再ハッシュや one-shot migration を用意。

---

## 優先度 Medium（次に着手）

### 4) Web フレームワークの将来性整理（Warp 継続か Axum へ段階移行か）
**狙い**
- 現在の Warp を活かしつつ、エコシステム活発度の高い Axum への移行余地を設計。

**効果**
- ミドルウェア導入（認証、レート制限、観測性）を標準的に組み込みやすい。

**実装の第一歩**
- 新規エンドポイントのみ Axum で追加する「ハイブリッド検証」または
  全面移行の PoC を 1 スプリントで評価。

---

### 5) 監視・観測性の強化（OpenTelemetry）
**狙い**
- `tracing` ログに加えて、**トレース/メトリクス**を外部基盤へ送る。

**効果**
- 遅延箇所（DB クエリ、ハンドラ処理）を可視化し、性能改善の優先順位を明確化。

**実装の第一歩**
- `tracing-opentelemetry` と exporter を導入。
- リクエスト単位の trace id をログ出力へ連携。

---

### 6) DB アクセス層の型安全性向上（段階的に `sqlx` 検討）
**狙い**
- 生 SQL + 手作業マッピングの負担を減らし、クエリ不整合をコンパイル時に検出。

**効果**
- メンテ時の破壊を低減、保守コスト削減。

**実装の第一歩**
- いきなり全面置換ではなく、変更頻度の高いクエリ群から段階導入。

---

## 優先度 Low（運用成熟フェーズ）

### 7) フロント資産管理の最小モダン化
**狙い**
- 現在の HTMX + 静的配信は維持しつつ、CSS/JS の品質管理を補強。

**候補**
- `biome` または `eslint + prettier` を静的資産に限定導入。
- Playwright で主要導線（ログイン/開始/回答）の E2E スモーク追加。

---

## 推奨ロードマップ（4〜6週間）
1. **Week 1-2**: Migration 基盤導入 + CI 品質ゲート追加。
2. **Week 2-3**: 管理者パスワードハッシュ化 + 既存データ移行。
3. **Week 3-4**: OpenTelemetry 最小導入（trace + 主要メトリクス）。
4. **Week 4-6**: Warp/Axum 方針決定 PoC、必要なら段階移行計画策定。

---

## すぐに着手できる最小タスク（3つ）
- [ ] `migrations/V1__init.sql` 作成、起動時 schema 直書きを撤去。
- [ ] CI に `fmt/clippy/test` を追加し、PR 必須チェック化。
- [ ] `argon2` で admin パスワードをハッシュ化。

